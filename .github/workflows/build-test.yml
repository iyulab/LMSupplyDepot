name: Build and Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - '.github/workflows/build-test.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'

env:
  DOTNET_VERSION: '9.0.x'
  CI: true
  GITHUB_ACTIONS: true

jobs:
  build-test:
    name: Build and Test
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Display build environment
      run: |
        echo "Build Environment Information:"
        echo "- Repository: ${{ github.repository }}"
        echo "- Branch: ${{ github.ref_name }}"
        echo "- Commit: ${{ github.sha }}"
        echo "- .NET Version: ${{ env.DOTNET_VERSION }}"
        echo "- CI Environment: ${{ env.CI }}"
        echo "- Skip LLama Backends: true (CI build)"
        echo ""
        echo "Directory structure:"
        Get-ChildItem -Path "src" -Directory | ForEach-Object { echo "  - $($_.Name)" }
      shell: powershell

    - name: Restore dependencies
      run: |
        echo "⚠️ Building without LLamaSharp backend packages for CI compatibility"
        echo "Temporarily disabling NU1507 warnings for CI build due to multiple package sources"
        dotnet restore src/LMSupplyDepots.sln --verbosity normal --disable-parallel -p:WarningsNotAsErrors=NU1507
      shell: powershell

    - name: Build solution
      run: |
        echo "Building all projects..."
        dotnet build src/LMSupplyDepots.sln --configuration Release --no-restore --verbosity normal -p:WarningsNotAsErrors=NU1507
      shell: powershell

    - name: Run tests
      run: |
        echo "Running CI tests (excluding LocalIntegration tests)..."
        dotnet test src/LMSupplyDepots.sln --configuration Release --no-build --verbosity normal --filter "Category!=LocalIntegration" -p:WarningsNotAsErrors=NU1507
      shell: powershell