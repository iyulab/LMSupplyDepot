name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: NuGet Security Audit

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Check for vulnerable packages
      run: |
        echo "🛡️ Running NuGet security audit..."

        # Run vulnerability scan
        SCAN_RESULT=$(dotnet list package --vulnerable --include-transitive)
        SCAN_EXIT_CODE=$?

        echo "$SCAN_RESULT"

        # Check if vulnerabilities were found
        if echo "$SCAN_RESULT" | grep -q "has the following vulnerable packages"; then
          echo "🚨 SECURITY ALERT: Vulnerable packages detected!"
          echo "VULNERABILITIES_FOUND=true" >> $GITHUB_ENV

          # Create security issue if this is main branch
          if [ "$GITHUB_REF" == "refs/heads/main" ]; then
            echo "SHOULD_CREATE_ISSUE=true" >> $GITHUB_ENV
          fi

          exit 1
        else
          echo "✅ No vulnerabilities found"
          echo "VULNERABILITIES_FOUND=false" >> $GITHUB_ENV
          exit 0
        fi

    - name: Run comprehensive security scan
      if: always()
      run: |
        # Make script executable
        chmod +x ./scripts/security-scan.ps1

        # Run PowerShell script on Linux using pwsh
        if command -v pwsh >/dev/null 2>&1; then
          pwsh -File ./scripts/security-scan.ps1 -Detailed -OutputFormat json
        else
          echo "PowerShell Core not available, skipping detailed scan"
        fi
      continue-on-error: true

    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-report
        path: |
          security-audit-*.json
          TestResults/
        retention-days: 30

    - name: Create security issue
      if: env.SHOULD_CREATE_ISSUE == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const title = `🚨 Security Alert: Vulnerable NuGet packages detected`;
          const body = `
          ## Security Vulnerability Report

          **Date**: ${new Date().toISOString()}
          **Branch**: ${context.ref}
          **Commit**: ${context.sha}

          ### Issue Description
          The automated security scan has detected vulnerable NuGet packages in the repository.

          ### Action Required
          1. Review the vulnerable packages listed in the workflow logs
          2. Update the affected packages to secure versions
          3. Test the application after updates
          4. Close this issue once vulnerabilities are resolved

          ### Workflow Run
          [View full security scan results](${context.payload.repository.html_url}/actions/runs/${context.runId})

          ---
          *This issue was automatically created by the security scanning workflow.*
          `;

          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['security', 'vulnerability', 'automated']
          });

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: moderate
        allow-licenses: MIT, Apache-2.0, BSD-3-Clause, ISC
        deny-licenses: GPL-2.0, GPL-3.0